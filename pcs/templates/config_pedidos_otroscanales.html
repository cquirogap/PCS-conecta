{% extends 'admin_base.html' %}
{% load static %}
{% block content %}
    <section class="content-header">
      <h1>
        <a href="/configuracion/orden_cliente_otroscanales/">Pedidos Otros Canales</a>
        <small>Configuracion</small>
      </h1>


      {% if messages %}
        {% for message in messages %}
            {% if message.tags %}
                <br>
                {% if message.level == DEFAULT_MESSAGE_LEVELS.INFO %}
                     <div class="alert alert-success alert-dismissible">
                        <button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
                        <h4><i class="icon fa fa-check"></i>Registro completado!</h4>{{ message }}
                     </div>
                {% endif %}
                {% if message.level == DEFAULT_MESSAGE_LEVELS.SUCCESS %}
                    <div class="alert alert-success alert-dismissible">
                        <button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
                        <h4><i class="icon fa fa-check"></i>Edición Exitosa!</h4>{{ message }}
                    </div>
                {% endif %}
                {% if message.level == DEFAULT_MESSAGE_LEVELS.WARNING %}
                    <div class="alert alert-warning alert-dismissible">
                        <button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
                        <h4><i class="icon fa fa-check"></i>Registro Borrado!</h4>{{ message }}
                    </div>
                {% endif %}
                {% if message.level == DEFAULT_MESSAGE_LEVELS.ERROR %}
                    <div class="alert alert-danger alert-dismissible">
                        <button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
                        <h4><i class="icon fa fa-ban"></i>Alerta!</h4>{{ message }}
                    </div>
                {% endif %}
            {% endif %}
        {% endfor %}
      {% endif %}
      <ol class="breadcrumb">
        <li><a href="#"><i class="fa fa-dashboard"></i> Configuracion</a></li>
        <li><a href="#">Solicitud</a></li>
      </ol>


    </section>
    <section>
    <div class="col-md-12">
          <div class="nav-tabs-custom">
              <!-- pestañas de el formulario-->
            <ul class="nav nav-tabs">
              <li class="active"><a href="#" data-toggle="tab">Pedidos Otros Canales </a></li>
              <li ><a href="/configuracion/excel_pedidos_externos/" >Excel Pedidos Otros Canales </a></li>
              <li ><a href="/configuracion/excel_pedidos_externos_distribuido/" >Excel Pedidos Distribuidos </a></li>

            </ul>
            <form role="form" action="/configuracion/orden_cliente_otroscanales/" method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="tab-content">
                <!-- barras de acceso -->
                <div class="active tab-pane" id="paises">
                    <br><br>
                    <p>Seleccione los productos con sus respondidas cantidades solicitadas:</p>
                    <br>
                    <!-- ... tu código HTML existente ... -->
                    <div id="formulario-duplicado">
                        <div class="row">
                        <div class="col-md-3">
                        <label>Referencia</label>
                        <div class="input-group">
                            <span class="input-group-addon"><i class="fa fa-bars"></i></span>
                            <input type="text" class="form-control predictivo" data-select-target=".select-referencias" placeholder="Buscar referencia">
                            <select class="form-control select-referencias" name="referencia[]">
                                <option value="" selected disabled></option>
                                {% for pedido in pedidos %}
                                <option value="{{ pedido.codigo }}_{{ pedido.nombre }}">{{ pedido.codigo }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                        <div class="col-md-3">
                        <label>PLU</label>
                        <div class="input-group">
                            <span class="input-group-addon"><i class="fa fa-bars"></i></span>
                            <input type="text" class="form-control predictivo" data-select-target=".select-plu" placeholder="Buscar PLU">
                            <select class="form-control select-plu" name="plu[]">
                                <option value="" selected disabled></option>
                                {% for pedido in pedidos %}
                                <option value="{{ pedido.codigo }}_{{ pedido.nombre }}">{{ pedido.plu }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                            <div class="col-md-3">
                        <label>EAN</label>
                        <div class="input-group">
                            <span class="input-group-addon"><i class="fa fa-bars"></i></span>
                            <input type="text" class="form-control predictivo" data-select-target=".select-n_producto" placeholder="Buscar EAN">
                            <select class="form-control select-n_producto" name="n_producto[]">
                                <option value="" selected disabled></option>
                                {% for pedido in pedidos %}
                                <option value="{{ pedido.codigo }}_{{ pedido.nombre }}">{{ pedido.n_producto }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

<div class="col-md-3">
                        <label>Descripción Producto</label>
                        <div class="input-group">
                            <span class="input-group-addon"><i class="fa fa-bars"></i></span>
                            <input type="text" class="form-control predictivo" data-select-target=".select-nombre" placeholder="Buscar nombre">
                            <select class="form-control select-nombre" name="nombre[]" required>
                                <option value="" selected disabled></option>
                                {% for pedido in pedidos %}
                                <option value="{{ pedido.codigo }}_{{ pedido.nombre }}">{{ pedido.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>


                            <div class="col-md-3">
                                <label>Cantidad</label>
                                <div class="input-group">
                                    <span class="input-group-addon"><i class="fa fa-file-text"></i></span>
                                    <input type="number" class="form-control" min="1" name="necesidad[]" placeholder="Cantidad" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label>Observaciones</label>
                                <div class="input-group">
                                    <span class="input-group-addon"><i class="fa fa-file-text"></i></span>
                                    <input type="text" class="form-control" name="observaciones[]" placeholder="Observaciones" >
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label>Imagen</label>
                                <img src="" alt="Imagen del producto" class="imagen-producto" style="max-width: 100%; height: 150px; width: 150px">

                            </div>
                        </div>
                        <br>
                    </div>
                    <script>
    document.addEventListener('DOMContentLoaded', function() {

        function obtenerImagen(valorSeleccionado, imagenProducto) {
            if (!valorSeleccionado) return; // Evita consultas innecesarias si no hay valor seleccionado

            fetch(`/ruta/obtener/imagen/?numero=${valorSeleccionado}`)
                .then(response => response.json())
                .then(data => {
                    imagenProducto.src = data.imagen || ''; // Si no hay imagen, deja vacío el src
                })
                .catch(error => {
                    imagenProducto.src = "";
                    console.error('Error al obtener la imagen:', error);
                });
        }

        function aplicarEventosImagen(formulario) {
            formulario.addEventListener('change', function(event) {
                const select = event.target;
                const contenedor = select.closest('.row');
                const imagenProducto = contenedor.querySelector('.imagen-producto');
                const selectReferencia = contenedor.querySelector('.select-referencias'); // Selecciona la referencia actual

                // Solo actuamos si el cambio ocurrió en alguno de los selects relevantes
                if (select.classList.contains('select-referencias') ||
                    select.classList.contains('select-plu') ||
                    select.classList.contains('select-n_producto') ||
                    select.classList.contains('select-nombre')) {

                    const valorSeleccionado = selectReferencia.value; // Siempre usamos el valor de referencia

                    if (imagenProducto && valorSeleccionado) {
                        obtenerImagen(valorSeleccionado, imagenProducto);
                    }
                }
            });
        }

        function aplicarAutocompletado() {
            const predictivos = document.querySelectorAll('.predictivo');
            predictivos.forEach(input => {
                input.addEventListener('input', function() {
                    const targetSelect = input.closest('.input-group').querySelector(input.getAttribute('data-select-target'));
                    const filter = input.value.toLowerCase();
                    const options = targetSelect.querySelectorAll('option');

                    options.forEach(option => {
                        const text = option.textContent.toLowerCase();
                        option.style.display = text.includes(filter) ? '' : 'none';
                    });
                });
            });
        }

        aplicarAutocompletado();

        const formularioOriginal = document.getElementById('formulario-duplicado');
        const contenedorFormularios = document.createElement('div');

        function sincronizarSelects(formulario) {
            const selectProducto = formulario.querySelector('.select-n_producto');
            const selectNombre = formulario.querySelector('.select-nombre');
            const selectPlu = formulario.querySelector('.select-plu');
            const selectReferencia = formulario.querySelector('.select-referencias');

            function actualizarSelects(origen) {
                const valorSeleccionado = origen.value.split('_');
                const nProducto = valorSeleccionado[0];

                [selectProducto, selectNombre, selectPlu, selectReferencia].forEach(select => {
                    for (let option of select.options) {
                        if (option.value.startsWith(nProducto)) {
                            select.value = option.value;
                            break;
                        }
                    }
                });
            }

            [selectProducto, selectNombre, selectPlu, selectReferencia].forEach(select => {
                select.addEventListener('change', function() {
                    actualizarSelects(select);
                });
            });
        }

        function clonarFormulario() {
            const formularioClonado = formularioOriginal.cloneNode(true);

            formularioClonado.querySelectorAll('input, select').forEach(campo => {
                campo.value = '';
            });

            const imagenProducto = formularioClonado.querySelector('.imagen-producto');
            if (imagenProducto) {
                imagenProducto.src = '';
            }

            contenedorFormularios.appendChild(formularioClonado);
            aplicarAutocompletado();
            sincronizarSelects(formularioClonado);
            aplicarEventosImagen(formularioClonado);

            const btnEliminar = document.createElement('button');
            btnEliminar.innerHTML = '<i class="fa fa-minus"></i>';
            btnEliminar.classList.add('btn-eliminar');
            btnEliminar.setAttribute('type', 'button');
            formularioClonado.appendChild(btnEliminar);

            btnEliminar.addEventListener('click', function() {
                contenedorFormularios.removeChild(formularioClonado);
            });
        }

        const btnDuplicar = document.createElement('button');
        btnDuplicar.innerHTML = '<i class="fa fa-plus"></i>';
        btnDuplicar.classList.add('btn-duplicar');
        btnDuplicar.setAttribute('type', 'button');
        btnDuplicar.addEventListener('click', clonarFormulario);

        formularioOriginal.parentNode.insertBefore(contenedorFormularios, formularioOriginal);
        formularioOriginal.parentNode.insertBefore(btnDuplicar, formularioOriginal);
        contenedorFormularios.appendChild(formularioOriginal);

        sincronizarSelects(formularioOriginal);
        aplicarEventosImagen(formularioOriginal);
    });
</script>



                </div>
                <br>
            <input type="submit" class="btn btn-primary btn-block btn-flat" value="ENVIAR">
                <!-- /.tab-content -->
          </div>
            </form>

          <!-- /.nav-tabs-custom -->
    </div>
    </div>
    </section>

{% endblock %}