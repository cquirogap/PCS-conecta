{% extends 'admin_base.html' %}
{% load static %}
{% block content %}

<section class="content-header" xmlns="http://www.w3.org/1999/html">
    <h1><a href="/configuracion/orden_pcs_otroscanales/"><i class="fa fa-mail-forward"></i>Volver</a></h1>
    {% if messages %}
        {% for message in messages %}
            {% if message.tags %}
                <br>
                {% if message.level == DEFAULT_MESSAGE_LEVELS.INFO %}
                     <div class="alert alert-success alert-dismissible">
                        <button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
                        <h4><i class="icon fa fa-check"></i>Registro completado!</h4>{{ message }}
                     </div>
                {% endif %}
                {% if message.level == DEFAULT_MESSAGE_LEVELS.SUCCESS %}
                    <div class="alert alert-success alert-dismissible">
                        <button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
                        <h4><i class="icon fa fa-check"></i>Edición Exitosa!</h4>{{ message }}
                    </div>
                {% endif %}
                {% if message.level == DEFAULT_MESSAGE_LEVELS.WARNING %}
                    <div class="alert alert-warning alert-dismissible">
                        <button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
                        <h4><i class="icon fa fa-check"></i>Registro Borrado!</h4>{{ message }}
                    </div>
                {% endif %}
                {% if message.level == DEFAULT_MESSAGE_LEVELS.ERROR %}
                    <div class="alert alert-danger alert-dismissible">
                        <button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
                        <h4><i class="icon fa fa-ban"></i>Alerta!</h4>{{ message }}
                    </div>
                {% endif %}
            {% endif %}
        {% endfor %}
      {% endif %}
</section>
<section class="invoice">
    {% csrf_token %}

    <div class="row">
        <div class="col-md-12">
            <h2 class="page-header">
<!--               Detalle Pedido # {% if pedido.numero_pedido_cliente %} {{ pedido.numero_pedido_cliente }}{% else %}{{ pedido }}{% endif %}-->
               Detalle Pedido # {{ pedido }}
            </h2>
        </div>
    </div>
    <div class="row no-print">

    </div>

    <div class="row invoice-info">
        <div class="col-sm-4 invoice-col">
            Cliente :<br>
            <strong>{{pedido.empresa.nombre}}</strong><br><br>
            <form role="form" action="/configuracion/orden_pcs_otroscanales/estado/" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" name="id"  value="{{ pedido.pk }}">
                <input type="hidden" name="pedido" value="{{ pedido }}">
                <label>Estado </label>
                <div class="input-group ">
                    <span class="input-group-addon"><i class="fa fa-check"></i></span>
                    <select class="form-control select2" style="width: 100%;" name="estado" required>
                            <option value="asignado" {% if pedido.estado == 'asignado' %}selected{% endif %}>Asignado</option>
                            <option value="pendiente" {% if pedido.estado == 'pendiente' %}selected{% endif %}>Pendiente</option>
                            <option value="en proceso" {% if pedido.estado == 'en proceso' %}selected{% endif %}>En proceso</option>
                            <option value="completado" {% if pedido.estado == 'completado' %}selected{% endif %}>Completado</option>
                    </select>
                    <span class="input-group-btn">
                        <button type="submit" class="btn btn-info btn-flat">Guardar</button>
                    </span>
                </div>
            </form>

        </div>
        <div class="col-sm-4 invoice-col">
            Fecha elaboración:<br>
            <strong>{{pedido.fecha}}</strong><br><br>
            <form role="form" action="/configuracion/orden_pcs_otroscanales/fecha_minima/" method="POST" enctype="multipart/form-data">
                        {% csrf_token %}
            <input type="hidden" name="id"  value="{{ pedido.pk }}">
            <input type="hidden" name="pedido" value="{{ pedido }}">
            <label>Fecha Mínima</label>
            <div class="input-group ">
                <span class="input-group-addon"><i class="fa fa-calendar "></i></span>
                <input type="date" class="form-control" id="fecha_inicio_input" name="fecha_minima" value="{{ pedido.fecha_minima|date:'Y-m-d' }}" >
                <span class="input-group-btn">
                    <button type="submit" class="btn btn-info btn-flat">Guardar</button>
                </span>
            </div>
            </form>
        </div>
        <div class="col-sm-4 invoice-col">
            Fecha Entrega:<br>
            <strong>{% if pedido.fecha_entrega == None %}{% else %}{{ pedido.fecha_entrega }}{% endif %}</strong><br><br>
            <form role="form" action="/configuracion/orden_pcs_otroscanales/fecha_maxima/" method="POST" enctype="multipart/form-data">
                        {% csrf_token %}
            <input type="hidden" name="id"  value="{{ pedido.pk }}">
            <input type="hidden" name="pedido" value="{{ pedido }}">
            <label>Fecha Máxima</label>
            <div class="input-group ">
                <span class="input-group-addon"><i class="fa fa-calendar "></i></span>
                <input type="date" class="form-control" id="fecha_inicio_input" name="fecha_maxima" value="{{ pedido.fecha_maxima|date:'Y-m-d' }}" >
                <span class="input-group-btn">
                    <button type="submit" class="btn btn-info btn-flat">Guardar</button>
                </span>
            </div>
            </form>
        </div>

    </div>

    <br><br>

<!--    <div class="row invoice-info">-->
<!--        <div class="col-sm-4 invoice-col">-->
<!--            <form role="form" action="/configuracion/orden_pcs_otroscanales/detalles_todos/" method="POST" enctype="multipart/form-data">-->
<!--                        {% csrf_token %}-->
<!--                        {% if solicitud.id == asignacion_editar.num_detalle.pk %}-->
<!--                            <input type="hidden" value="{{ asignacion_editar.pk }}" name="id_asignacion" id="id_asignacion">-->
<!--                        {% endif %}-->
<!--                        <div class="input-group">-->
<!--                            <span class="input-group-addon"><i class="fa fa-users"></i></span>-->
<!--                            <select class="form-control select2" style="width: 100%;" name="empresa" required>-->
<!--                                <option value="T"  selected disabled></option>-->
<!--                                {% for empresa in empresas %}-->
<!--                                    <option value="{{ empresa.id }}" {% if solicitud.id == asignacion_editar.num_detalle.pk %}-->
<!--                                            {% if asignacion_editar.empresa.id == empresa.id %}selected{% endif %}{% endif %}>-->
<!--                                        {{ empresa.nombre }}-->
<!--                                    </option>-->
<!--                                {% endfor %}-->
<!--                            </select>-->

<!--                        </div>-->

<!--                        <input type="hidden" name="pedido" value="{{ pedido }}">-->
<!--                        <br>-->
<!--                        <button type="submit" class="btn btn-block btn-primary btn-flat">ASIGNAR A TODO</button>-->
<!--                    </form>-->
<!--        </div>-->
<!--    </div>-->
<!--   <hr/>-->
<!--   <div class="row">-->
<!--        <div class="col-xs-12 table-responsive">-->
<!--            <table class="table table-striped">-->
<!--                <thead>-->
<!--                    <tr>-->
<!--                        <th>U_PLU</th>-->
<!--                        <th>Necesidad </th>-->
<!--                        <th>Observacion </th>-->
<!--                        <th>Asignar Empresario</th>-->
<!--                    </tr>-->
<!--                </thead>-->
<!--                <tbody>-->
<!--                {% for solicitud_plu in pedidodetalle_plu %}-->
<!--                <tr>-->
<!--                    <td>{{solicitud_plu.u_plu}}</td>-->
<!--                    <td>{{solicitud_plu.cantidad }}-->
<!--                    <td>{{solicitud_plu.observaciones}}</td>-->
<!--                    <td>-->
<!--                        <form role="form" action="/configuracion/orden_pcs_otroscanales_plus/detalles/" method="POST" enctype="multipart/form-data">-->
<!--                        {% csrf_token %}-->
<!--                        <div class="input-group">-->
<!--                            <span class="input-group-addon"><i class="fa fa-users"></i></span>-->
<!--                            <select class="form-control select2" style="width: 100%;" name="empresa" required>-->
<!--                                {% for empresa in empresas %}-->
<!--                                {% if empresa.codigo in solicitud_plu.articulos %}-->
<!--                                    <option value="{{ empresa.id }}" {% if solicitud.id == asignacion_editar.num_detalle.pk %}-->
<!--                                            {% if asignacion_editar.empresa.id == empresa.id %}selected{% endif %}{% endif %}>-->
<!--                                        {{ empresa.nombre }}-->
<!--                                    </option>-->
<!--                                {% endif %}-->
<!--                                {% endfor %}-->
<!--                            </select>-->
<!--                        </div>-->
<!--                        <div class="input-group ">-->
<!--                            <span class="input-group-addon"><i class="fa fa-navicon  "></i></span>-->
<!--                            <input type="number" class="form-control" id="cantidad_plu"-->
<!--                                   name="cantidad_plu" placeholder="Cantidad" required>-->
<!--                        </div>-->
<!--                        <br>-->
<!--                        <input type="hidden" name="id" value="{{ solicitud_plu.id }}">-->
<!--                        <input type="hidden" name="pedido" value="{{ pedido }}">-->
<!--                        <button type="submit" class="btn btn-block btn-primary btn-flat">ASIGNAR</button>-->
<!--                    </form>-->
<!--                    </td>-->
<!--                </tr>-->
<!--                {% endfor %}-->
<!--                </tbody>-->
<!--            </table>-->
<!--        </div>-->
<!--    </div>-->
<!--   <hr/>-->
    <br><br>
    <br>
    <div class="row">
        <input type="hidden" id="pedido_pk" value="{{ pedido.pk }}">
        <div class="col-xs-12 table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th></th>
                        <th>U_PLU</th>
                        <th>Referencia</th>
                        <th>Descripcion</th>
                        <th>Necesidad </th>
                        <th>Observacion </th>
                        <th>Editar</th>
                        <th>Asignar Empresario</th>
                    </tr>
                </thead>
                <tbody>
                {% for solicitud in pedidodetalle %}
                <tr>
                    <td>
<!--                        <a class="btn btn-social-icon btn-google"-->
<!--                              href="/configuracion/orden_pcs_otroscanales/producto/eliminar/{{ solicitud.id }}/?pedido={{ pedido.pk }}">-->
<!--                        <i class="fa fa-trash"></i>-->
<!--                        </a>-->
                    </td>
                    <td>{{ solicitud.u_plu}}</td>
                    <td>{{ solicitud.referencia }}
                    {% for asignaciones in solicitud.asignaciones %}
                        <br>
                        <small>{{ asignaciones.empresa.nombre }}</small>
                        {% endfor %}
                    </td>
                    <td>{{ solicitud.nombre }}</td>
                    <td>{{ solicitud.cantidad }}
                    {% for asignaciones in solicitud.asignaciones %}
                        <br>
                        <small>{{ asignaciones.cantidad }}
                        </small>
                        {% endfor %}</td>
                    <td>{{ solicitud.observaciones }}</td>
                    <td>{% for asignaciones in solicitud.asignaciones %}
                        <br>
                        <a class="btn btn-social-icon btn-bitbucket"
                              href="/configuracion/orden_pcs_otroscanales/detalle/{{ pedido }}/?asignacion={{ asignaciones.pk }}">
                        <i class="fa fa-pencil"></i>
                        </a>
                        <a class="btn btn-social-icon btn-google"
                                  href="/configuracion/orden_pcs_otroscanales/eliminar/{{ pedido }}/?asignacion={{ asignaciones.pk }}">
                            <i class="fa fa-trash"></i>
                        </a>
                        </small>
                        {% endfor %}</td>
                    <td><form role="form" action="/configuracion/orden_pcs_otroscanales/detalles/" method="POST" enctype="multipart/form-data">
                        {% csrf_token %}
                        {% if solicitud.id == asignacion_editar.num_detalle.pk %}
                            <input type="hidden" value="{{ asignacion_editar.pk }}" name="id_asignacion" id="id_asignacion">
                        {% endif %}
                        <div class="input-group">
                            <span class="input-group-addon"><i class="fa fa-users"></i></span>
                            <select class="form-control select2" style="width: 100%;" name="empresa" required>
                                {% for empresa in empresas %}
                                {% if empresa.codigo in solicitud.articulos %}
                                    <option value="{{ empresa.id }}" {% if solicitud.id == asignacion_editar.num_detalle.pk %}
                                            {% if asignacion_editar.empresa.id == empresa.id %}selected{% endif %}{% endif %}>
                                        {{ empresa.nombre }}
                                    </option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <div class="input-group ">
                            <span class="input-group-addon"><i class="fa fa-navicon  "></i></span>
                            <input type="number" class="form-control" id="cantidad"
                                   name="cantidad" placeholder="Cantidad"  {% if solicitud.id == asignacion_editar.num_detalle.pk %}
                                   value="{{ asignacion_editar.cantidad }}"{% endif %} required>
                        </div>
                        <input type="hidden" name="id" value="{{ solicitud.id }}">
                        <input type="hidden" name="pedido" value="{{ pedido }}">
                        <br>
                        <button type="submit" class="btn btn-block btn-primary btn-flat">ASIGNAR</button>
                    </form>
                    </td>
                </tr>
                {% endfor %}
                {% for solicitud_plu in pedidodetalle_plu %}
                <tr>
                    <td></td>
                    <td><strong>{{solicitud_plu.u_plu}}</strong></td>
                    <td></td>
                    <td></td>
                    <td><strong>{{solicitud_plu.cantidad }}</strong></td>
                    <td>{{solicitud_plu.observaciones}}</td>
                    <td></td>
                    <td>
                        <form role="form" action="/configuracion/orden_pcs_otroscanales_plus/detalles/" method="POST" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="input-group">
                            <span class="input-group-addon"><i class="fa fa-users"></i></span>
                            <select class="form-control select2" style="width: 100%;" name="empresa" required>
                                <option value="T"  selected disabled></option>
                                {% for empresa in empresas %}
                                {% if empresa.codigo in solicitud_plu.articulos %}
                                    <option value="{{ empresa.id }}" {% if solicitud.id == asignacion_editar.num_detalle.pk %}
                                            {% if asignacion_editar.empresa.id == empresa.id %}selected{% endif %}{% endif %}>
                                        {{ empresa.nombre }}
                                    </option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <div class="input-group ">
                            <span class="input-group-addon"><i class="fa fa-navicon  "></i></span>
                            <input type="number" class="form-control" id="cantidad_plu"
                                   name="cantidad_plu" placeholder="Cantidad" required>
                        </div>
                        <br>
                        <input type="hidden" name="id" value="{{ solicitud_plu.id }}">
                        <input type="hidden" name="pedido" value="{{ pedido }}">
                        <button type="submit" class="btn btn-block btn-primary btn-flat">ASIGNAR</button>
                    </form>
                    </td>
                </tr>
                {% for solicitud in pedidodetalle_multiple %}
                {% if solicitud_plu.u_plu == solicitud.u_plu %}
                <tr>
                    <td>
                        <a class="btn btn-social-icon btn-google"
                              href="/configuracion/orden_pcs_otroscanales/producto/eliminar/{{ solicitud.id }}/?pedido={{ pedido.pk }}">
                        <i class="fa fa-trash"></i>
                        </a>
                    </td>
                    <td>{{ solicitud.u_plu}}</td>
                    <td>{{ solicitud.referencia }}
                    {% for asignaciones in solicitud.asignaciones %}
                        <br>
                        <small>{{ asignaciones.empresa.nombre }}</small>
                        {% endfor %}
                    </td>
                    <td>{{ solicitud.nombre }}</td>
                    <td>{{ solicitud.cantidad }}
                    {% for asignaciones in solicitud.asignaciones %}
                        <br>
                        <small>{{ asignaciones.cantidad }}
                        </small>
                        {% endfor %}</td>
                    <td>{{ solicitud.observaciones }}</td>
                    <td>{% for asignaciones in solicitud.asignaciones %}
                        <br>
                        <a class="btn btn-social-icon btn-bitbucket"
                              href="/configuracion/orden_pcs_otroscanales/detalle/{{ pedido }}/?asignacion={{ asignaciones.pk }}">
                        <i class="fa fa-pencil"></i>
                        </a>
                        <a class="btn btn-social-icon btn-google"
                                  href="/configuracion/orden_pcs_otroscanales/eliminar/{{ pedido }}/?asignacion={{ asignaciones.pk }}">
                            <i class="fa fa-trash"></i>
                        </a>
                        </small>
                        {% endfor %}</td>
                    <td><form role="form" action="/configuracion/orden_pcs_otroscanales/detalles/" method="POST" enctype="multipart/form-data">
                        {% csrf_token %}
                        {% if solicitud.id == asignacion_editar.num_detalle.pk %}
                            <input type="hidden" value="{{ asignacion_editar.pk }}" name="id_asignacion" id="id_asignacion">
                        {% endif %}
                        <div class="input-group">
                            <span class="input-group-addon"><i class="fa fa-users"></i></span>
                            <select class="form-control select2" style="width: 100%;" name="empresa" required>
                                {% for empresa in empresas %}
                                {% if empresa.codigo in solicitud.articulos %}
                                    <option value="{{ empresa.id }}" {% if solicitud.id == asignacion_editar.num_detalle.pk %}
                                            {% if asignacion_editar.empresa.id == empresa.id %}selected{% endif %}{% endif %}>
                                        {{ empresa.nombre }}
                                    </option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <div class="input-group ">
                            <span class="input-group-addon"><i class="fa fa-navicon  "></i></span>
                            <input type="number" class="form-control" id="cantidad"
                                   name="cantidad" placeholder="Cantidad"  {% if solicitud.id == asignacion_editar.num_detalle.pk %}
                                   value="{{ asignacion_editar.cantidad }}"{% endif %} required>
                        </div>
                        <input type="hidden" name="id" value="{{ solicitud.id }}">
                        <input type="hidden" name="pedido" value="{{ pedido }}">
                        <br>
                        <button type="submit" class="btn btn-block btn-primary btn-flat">ASIGNAR</button>
                    </form>
                    </td>
                </tr>
                {% endif %}
                {% endfor %}
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
<script>
document.addEventListener("DOMContentLoaded", function () {
    // Interceptar los formularios de asignación
    document.querySelectorAll("form[action='/configuracion/orden_pcs_otroscanales/detalles/']").forEach(form => {
        form.addEventListener("submit", function (e) {
            e.preventDefault();

            let formData = new FormData(form);

            fetch(form.action, {
                method: "POST",
                body: formData,
                headers: { "X-Requested-With": "XMLHttpRequest" }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("✅ " + data.message);

                    // Buscar la fila por el detalle_id
                    let fila = document.querySelector(`tr input[name="id"][value="${data.detalle_id}"]`)?.closest("tr");
                    if (fila) {
                        let colReferencia = fila.cells[2];
                        let colCantidad = fila.cells[4];
                        let colAcciones = fila.cells[6];

                        // Extraer el texto base (referencia y cantidad solicitada)
                        let referenciaTexto = fila.cells[2].childNodes[0].nodeValue.trim();
                        let cantidadSolicitada = fila.cells[4].childNodes[0].nodeValue.trim();

                        // Limpiar contenido de asignaciones
                        colReferencia.innerHTML = referenciaTexto;
                        colCantidad.innerHTML = cantidadSolicitada;
                        colAcciones.innerHTML = "";

                        // Insertar asignaciones actualizadas
                        data.asignaciones.forEach(asig => {
                            colReferencia.innerHTML += `<br><small>${asig.empresa}</small>`;
                            colCantidad.innerHTML += `<br><small>${asig.cantidad}</small>`;

                            colAcciones.innerHTML += `
                                <br>
                                <a class="btn btn-social-icon btn-bitbucket"
                                   href="/configuracion/orden_pcs_otroscanales/detalle/${data.pedido_id}/?asignacion=${asig.id}">
                                   <i class="fa fa-pencil"></i>
                                </a>
                                <a class="btn btn-social-icon btn-google"
                                   href="/configuracion/orden_pcs_otroscanales/eliminar/${data.pedido_id}/?asignacion=${asig.id}">
                                   <i class="fa fa-trash"></i>
                                </a>
                            `;
                        });
                    }

                    // Resetear formulario después de asignar
                    form.reset();
                } else {
                    alert("⚠️ " + data.message);
                }
            })
            .catch(err => {
                console.error(err);
                alert("❌ Error en la comunicación con el servidor.");
            });
        });
    });
});
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    document.getElementById("buscar_edi_otros_canales_button").addEventListener("click", function () {
        let filas = document.querySelectorAll("tbody tr");
        let productos = {};

        filas.forEach(fila => {
            let referencia = fila.cells[0].innerText.trim(); // Obtiene la referencia del producto
            let cantidadSolicitada = parseInt(fila.cells[2].childNodes[0].nodeValue.trim()) || 0; // Obtiene la cantidad solicitada

            let asignaciones = fila.cells[2].querySelectorAll("small"); // Busca las asignaciones en la misma fila
            let cantidadAsignada = 0;

            asignaciones.forEach(asignacion => {
                cantidadAsignada += parseInt(asignacion.innerText.trim()) || 0;
            });

            // Guardar en el objeto productos para validación
            productos[referencia] = {
                cantidadSolicitada,
                cantidadAsignada
            };
        });

        // Validar si las cantidades coinciden
        let errores = [];
        for (let producto in productos) {
            if (productos[producto].cantidadSolicitada !== productos[producto].cantidadAsignada) {
                errores.push(`Producto: ${producto} → Solicitado: ${productos[producto].cantidadSolicitada}, Asignado: ${productos[producto].cantidadAsignada}`);
            }
        }

        // Si hay errores, mostrar alerta y detener el proceso
        if (errores.length > 0) {
            alert("⚠️ Error: Las siguientes asignaciones no coinciden con las cantidades solicitadas:\n\n" + errores.join("\n"));
        } else {
            alert("✅ Todas las asignaciones son correctas. Procediendo con la generación del EDI.");
            // Aquí podrías agregar la lógica para continuar con la generación del EDI.
        }
    });
});
</script>
    <br>

    <br>

    <br>
    <div class="row no-print">

    </div>

</section>
<button type="button" id="buscar_edi_otros_canales_button" class="btn btn-primary pull-right" style="margin-right: 5px;">
        <i class="fa fa-download"></i> Generar EDI
    </button>
{% endblock %}